rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Fonction helper pour vérifier si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Fonction helper pour obtenir le rôle de l'utilisateur
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Fonction helper pour vérifier si l'utilisateur est professionnel
    function isProfessional() {
      return isAuthenticated() && getUserRole() in ['praticien', 'kine', 'manager', 'admin', 'sadmin', 'secretaire'];
    }
    
    // Fonction helper pour vérifier si l'utilisateur est manager ou admin
    function isManagerOrAdmin() {
      return isAuthenticated() && getUserRole() in ['manager', 'admin', 'sadmin'];
    }
    
    // Collection USERS
    match /users/{userId} {
      // Lecture : tout utilisateur authentifié peut lire tous les profils
      allow read: if isAuthenticated();
      
      // Écriture : uniquement son propre profil OU manager/admin
      allow write: if isAuthenticated() && 
        (request.auth.uid == userId || isManagerOrAdmin());
    }
    
    // Collection CENTRES
    match /centres/{centreId} {
      // Lecture : tout utilisateur authentifié
      allow read: if isAuthenticated();
      
      // Écriture : seulement manager/admin
      allow write: if isManagerOrAdmin();
    }
    
    // Collection PATIENTS
    match /patients/{patientId} {
      // Lecture/Écriture : seulement les professionnels
      allow read, write: if isProfessional();
    }
    
    // Collection APPOINTMENTS (Rendez-vous)
    match /appointments/{appointmentId} {
      // Lecture : professionnels + patient concerné
      allow read: if isAuthenticated() && (
        isProfessional() || 
        resource.data.patient_id == request.auth.uid
      );
      
      // Écriture : seulement professionnels
      allow write: if isProfessional();
    }
    
    // Collection PAIN_TRACKING (Cartographie des douleurs)
    match /pain_tracking/{trackingId} {
      // Lecture : le patient concerné + les professionnels
      allow read: if isAuthenticated() && (
        resource.data.patient_id == request.auth.uid ||
        isProfessional()
      );
      
      // Écriture : seulement le patient concerné
      allow write: if isAuthenticated() && 
        request.resource.data.patient_id == request.auth.uid;
    }
    
    // Collection SESSIONS (Notes de séance)
    match /sessions/{sessionId} {
      // Lecture : le patient concerné + les professionnels
      allow read: if isAuthenticated() && (
        resource.data.patient_id == request.auth.uid ||
        isProfessional()
      );
      
      // Écriture : seulement professionnels
      allow write: if isProfessional();
    }
    
    // Collection AUDIT_LOGS (Traçabilité RGPD)
    match /audit_logs/{logId} {
      // Lecture : l'utilisateur concerné + manager/admin
      allow read: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        isManagerOrAdmin()
      );
      
      // Écriture : tous les utilisateurs authentifiés (pour créer leurs propres logs)
      allow create: if isAuthenticated();
      
      // Modification/Suppression : seulement admin
      allow update, delete: if isManagerOrAdmin();
    }
    
    // Collection MESSAGES (Messagerie - future)
    match /messages/{messageId} {
      // Lecture : expéditeur ou destinataire
      allow read: if isAuthenticated() && (
        resource.data.from_user_id == request.auth.uid ||
        resource.data.to_user_id == request.auth.uid
      );
      
      // Écriture : créer un message dont on est l'expéditeur
      allow create: if isAuthenticated() && 
        request.resource.data.from_user_id == request.auth.uid;
      
      // Modification : seulement l'expéditeur (pour marquer comme lu par exemple)
      allow update: if isAuthenticated() && 
        resource.data.from_user_id == request.auth.uid;
      
      // Suppression : expéditeur ou destinataire
      allow delete: if isAuthenticated() && (
        resource.data.from_user_id == request.auth.uid ||
        resource.data.to_user_id == request.auth.uid
      );
    }
    
    // Règle par défaut : DENY ALL
    // Toute collection non explicitement définie ci-dessus est interdite
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
